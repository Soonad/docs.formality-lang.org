

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>} &mdash; Formality-Core 0.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Formality-Core
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="Installation.html">1. fmc</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Formality-Core</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>}</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/language/Dups-and-Boxes.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p>## Dups and Boxes</p>
<p>Formality-Core includes 2 primitives for explicit, deep copying of arbitrary terms:</p>
<p>syntax | effect
— | —
<cite># a</cite> | Puts <cite>a</cite> inside a box
<cite>dup x = #a …</cite> | Unwraps <cite>a</cite> from a box, makes <cite>n</cite> copies of it as <cite>x</cite></p>
<p>In order to explain how those work, let’s make a quick detour and explain about complexity.</p>
<p>## Measuring complexity</p>
<p>As mentioned, <a href="#id1"><span class="problematic" id="id2">`</span></a>let`s and <a href="#id3"><span class="problematic" id="id4">`</span></a>def`s are very useful for improving your code organization, but they have no computational effect, i.e., they disappear after parsing. This may cause your program to duplicate work. For example:</p>
<p><a href="#id5"><span class="problematic" id="id6">``</span></a><a href="#id7"><span class="problematic" id="id8">`</span></a>javascript
def main:</p>
<blockquote>
<div>let num = ||1 + 2| + <a href="#id103"><span class="problematic" id="id104">|3 + 4||</span></a>
[num, num]</div></blockquote>
<p><a href="#id9"><span class="problematic" id="id10">``</span></a><a href="#id11"><span class="problematic" id="id12">`</span></a></p>
<p>The program above is equivalent to:</p>
<p><a href="#id13"><span class="problematic" id="id14">``</span></a><a href="#id15"><span class="problematic" id="id16">`</span></a>javascript
def main:</p>
<blockquote>
<div>[||1 + 2| + <a href="#id105"><span class="problematic" id="id106">|3 + 4||</span></a>, ||1 + 2| + <a href="#id107"><span class="problematic" id="id108">|3 + 4||</span></a>]</div></blockquote>
<p><a href="#id17"><span class="problematic" id="id18">``</span></a><a href="#id19"><span class="problematic" id="id20">`</span></a></p>
<p>And, as such, wastefully evaluates <cite>||1 + 2| + |3 + 4||</cite> twice. One of the nice things about Formality-Core is that it has a very clear cost model, so we can precisely measure this problem. Save the program above and run it with <cite>fmc -ns main</cite>. The <cite>-ns</cite> flags ask <cite>fmc</cite> to run your program with interaction net system (instead of interpreter), and to output the number of “rewrites” needed to fully execute it. Rewrites are lightweight, constant-spacetime operations. In other words, this number is a very good measure of the complexity of the program. A program that takes <cite>400</cite> rewrites is roughly 2x slower than one that takes <cite>200</cite>, and so on. The program above needs <cite>12</cite> rewrites:</p>
<p><a href="#id21"><span class="problematic" id="id22">``</span></a><a href="#id23"><span class="problematic" id="id24">`</span></a>bash
$ fmc -ns main
[10,10]
{</p>
<blockquote>
<div>“rewrites”: 12,
“passes”: 6</div></blockquote>
<div class="section" id="id25">
<h1>}<a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h1>
<p>In order to avoid this waste and copy/clone values efficiently, Formality-Core includes a boxed duplication system, which we’ll explain now. The first thing to learn about is boxes.</p>
<p>## Boxes</p>
<p>Boxes are like containers with only one element. You can put any term inside a box using the <cite>#</cite> syntax. For example:</p>
<p><a href="#id26"><span class="problematic" id="id27">``</span></a><a href="#id28"><span class="problematic" id="id29">`</span></a>javascript
def main:</p>
<blockquote>
<div># “I’m the man in the box”</div></blockquote>
<p><a href="#id30"><span class="problematic" id="id31">``</span></a><a href="#id32"><span class="problematic" id="id33">`</span></a></p>
<p>In the program above, the string literal is inside of a box. You can put boxes anywhere you want to. For example:</p>
<p><a href="#id34"><span class="problematic" id="id35">``</span></a><a href="#id36"><span class="problematic" id="id37">`</span></a>javascript
def main:</p>
<blockquote>
<div># [##1, [2, #”a cat”]]</div></blockquote>
<p><a href="#id38"><span class="problematic" id="id39">``</span></a><a href="#id40"><span class="problematic" id="id41">`</span></a></p>
<p>The program above puts 4 boxes in different places. If we use the analogy that <em>“a box is like an array with one element”</em>, then it could be written in Python as:</p>
<p><a href="#id42"><span class="problematic" id="id43">``</span></a><a href="#id44"><span class="problematic" id="id45">`</span></a>python
# Python “equivalent”
def main():</p>
<blockquote>
<div>print ([[1]], (2, [“a cat”]))</div></blockquote>
<p><a href="#id46"><span class="problematic" id="id47">``</span></a><a href="#id48"><span class="problematic" id="id49">`</span></a></p>
<p>## Duplications</p>
<p>The reason boxes exist is to enable Formality-Core’s explicit duplications, which are essentially deep copies of arbitrary values. To perform those, you must use the <cite>dup</cite> syntax:</p>
<p><a href="#id50"><span class="problematic" id="id51">``</span></a><a href="#id52"><span class="problematic" id="id53">`</span></a>javascript
def main:</p>
<blockquote>
<div>dup num = #||1 + 2| + <a href="#id109"><span class="problematic" id="id110">|3 + 4||</span></a>
# [num, num]</div></blockquote>
<p><a href="#id54"><span class="problematic" id="id55">``</span></a><a href="#id56"><span class="problematic" id="id57">`</span></a></p>
<p>As you can see, this is very similar to the first program presented, with two differences: the <cite>dup</cite> keyword is used instead of <cite>let</cite>, and there is a box (<cite>#</cite>) wrapping the duplicated value and the result. The effect of <cite>dup</cite> is that it takes a boxed value (in this case, <cite>#||1 + 2| + |3 + 4||</cite>), unboxes it (obtaining <cite>||1 + 2| + |3 + 4||</cite>) and replaces every occurrence of <cite>num</cite> by a copy. The result of this program is, ignoring the box, the same as:</p>
<p><a href="#id58"><span class="problematic" id="id59">``</span></a><a href="#id60"><span class="problematic" id="id61">`</span></a>javascript
# [10,10]
{</p>
<blockquote>
<div>“rewrites”: 7,
“passes”: 5</div></blockquote>
</div>
<div class="section" id="id62">
<h1>}<a class="headerlink" href="#id62" title="Permalink to this headline">¶</a></h1>
<p>Except that now it needed roughly half of the rewrites and, thus, it is twice as fast. This is because duplications are done optimally, so, in this case, the additions were performed before duplicating. This is, of course, a simple example, but in more complex, highly functional programs, clever usage of <cite>dup</cite> can amount to huge, asymptotical speedups.</p>
<p>## The stratification condition</p>
<p>Sadly, in order to use <cite>dup</cite>, there is an important condition that must be met:</p>
<p>&gt; The number of boxes wrapping a term can never change through the program’s evaluation.</p>
<p>This is the stratification condition and it essentially causes Formality-Core programs to be split into “layers”, based on how boxes are placed. To explain it, let’s present an example. Mind the code below:</p>
<p><a href="#id63"><span class="problematic" id="id64">``</span></a><a href="#id65"><span class="problematic" id="id66">`</span></a>javascript
def main:</p>
<blockquote>
<div>[0, [#1, #[#2, ##3]]]</div></blockquote>
<p><a href="#id67"><span class="problematic" id="id68">``</span></a><a href="#id69"><span class="problematic" id="id70">`</span></a></p>
<p>Here, the number <cite>0</cite> isn’t wrapped by any box. As such, it is on <cite>layer 0</cite>. The number <cite>1</cite> is wrapped by one box, so it is on <cite>layer 1</cite>. The entire <cite>[#2, ##3]</cite> pair is wrapped by one box, so, <cite>2</cite> is wrapped by 2 boxes in total and, thus, is on <cite>layer 2</cite>, while <cite>3</cite> is wrapped by 3 boxes in total and, thus, is on <cite>layer 3</cite>.</p>
<p>What the stratification condition says is that a term can never migrate from a layer to another. This means that the program below is not legal:</p>
<p><a href="#id71"><span class="problematic" id="id72">``</span></a><a href="#id73"><span class="problematic" id="id74">`</span></a>javascript
def main:</p>
<blockquote>
<div>dup num = # 42
[num, num]</div></blockquote>
<p><a href="#id75"><span class="problematic" id="id76">``</span></a><a href="#id77"><span class="problematic" id="id78">`</span></a></p>
<p>Because, before reduction, <cite>42</cite> is on <cite>layer 1</cite>, but, after reduction, it would be on <cite>layer 0</cite>. This can’t happen. If you try to run the program above, it will present a compile-time error. Similarly, the program below is illegal too:</p>
<p><a href="#id79"><span class="problematic" id="id80">``</span></a><a href="#id81"><span class="problematic" id="id82">`</span></a>javascript
def main:</p>
<blockquote>
<div>dup num = # 42
## [num, num]</div></blockquote>
<p><a href="#id83"><span class="problematic" id="id84">``</span></a><a href="#id85"><span class="problematic" id="id86">`</span></a></p>
<p>Because, if we evaluated it, <cite>42</cite> would migrate from <cite>layer 1</cite> to <cite>layer 2</cite>, which can’t happen. Trying to run it would result in a compile-time error too. This program is correct:</p>
<p><a href="#id87"><span class="problematic" id="id88">``</span></a><a href="#id89"><span class="problematic" id="id90">`</span></a>javascript
def main:</p>
<blockquote>
<div>dup num = # 42
# [num, num]</div></blockquote>
<p><a href="#id91"><span class="problematic" id="id92">``</span></a><a href="#id93"><span class="problematic" id="id94">`</span></a></p>
<p>Because each occurrence of <cite>num</cite> is on <cite>layer 1</cite>, which is the same layer where <cite>42</cite> is from. This program is also correct:</p>
<p><a href="#id95"><span class="problematic" id="id96">``</span></a><a href="#id97"><span class="problematic" id="id98">`</span></a>javascript
def main:</p>
<blockquote>
<div>dup num = # 42
[#num, #num]</div></blockquote>
<p><a href="#id99"><span class="problematic" id="id100">``</span></a><a href="#id101"><span class="problematic" id="id102">`</span></a></p>
<p>Because, once again, each occurrence of <cite>num</cite> is on <cite>layer 1</cite>. This means you’re able to place boxes as you wish, as long as it doesn’t break the stratification condition.</p>
<p>The stratification condition is what allows Formality-Core to be evaluated by the fastest interaction-net reduction algorithm known, dispensing the expensive “bookkeeping mechanism” used by other optimal evaluators.</p>
<p>[&lt; If and Cpy](<a class="reference external" href="https://github.com/moonad/Formality/wiki/If-and-Cpy">https://github.com/moonad/Formality/wiki/If-and-Cpy</a>)  |  [Lambdas and Affinity &gt;](<a class="reference external" href="https://github.com/moonad/Formality/wiki/Lambdas-and-Affinity">https://github.com/moonad/Formality/wiki/Lambdas-and-Affinity</a>)</p>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Sunshine Cybernetics

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>