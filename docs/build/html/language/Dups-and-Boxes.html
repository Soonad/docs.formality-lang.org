

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>8. Dups and Boxes &mdash; Formality-Core 0.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="9. Lambdas and Affinity" href="Lambdas-and-Affinity.html" />
    <link rel="prev" title="7. If and Cpy" href="If-and-Cpy.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Formality-Core
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Why-Formality-Core?.html">1. Why Formality-Core?</a></li>
<li class="toctree-l1"><a class="reference internal" href="Installation.html">2. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Hello,-world!.html">3. Hello, World!</a></li>
<li class="toctree-l1"><a class="reference internal" href="Numbers-and-Operators.html">4. Numbers and Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="Pairs.html">5. Pairs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lets-and-Defs.html">6. Lets and Defs</a></li>
<li class="toctree-l1"><a class="reference internal" href="If-and-Cpy.html">7. If and Cpy</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">8. Dups and Boxes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#measuring-complexity">8.1. Measuring complexity</a></li>
<li class="toctree-l2"><a class="reference internal" href="#boxes">8.2. Boxes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#duplications">8.3. Duplications</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-stratification-condition">8.4. The stratification condition</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Lambdas-and-Affinity.html">9. Lambdas and Affinity</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Formality-Core</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>8. Dups and Boxes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/language/Dups-and-Boxes.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="dups-and-boxes">
<h1>8. Dups and Boxes<a class="headerlink" href="#dups-and-boxes" title="Permalink to this headline">¶</a></h1>
<p>Formality-Core includes 2 primitives for explicit, deep copying of arbitrary terms:</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>syntax</th>
<th>effect</th>
</tr>
</thead>
<tbody>
<tr>
<td><code># a</code></td>
<td>Puts <code>a</code> inside a box</td>
</tr>
<tr>
<td><code>dup x = #a ...</code></td>
<td>Unwraps <code>a</code> from a box, makes <code>n</code> copies of it as <code>x</code></td>
</tr>
</tbody>
</table><p>In order to explain how those work, let’s make a quick detour and explain about complexity.</p>
<div class="section" id="measuring-complexity">
<h2>8.1. Measuring complexity<a class="headerlink" href="#measuring-complexity" title="Permalink to this headline">¶</a></h2>
<p>As mentioned, <code class="docutils literal notranslate"><span class="pre">let</span></code>s and <code class="docutils literal notranslate"><span class="pre">def</span></code>s are very useful for improving your code organization, but they have no computational effect, i.e., they disappear after parsing. This may cause your program to duplicate work. For example:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">def</span> <span class="nx">main</span><span class="o">:</span>
  <span class="kd">let</span> <span class="nx">num</span> <span class="o">=</span> <span class="o">||</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">|</span> <span class="o">+</span> <span class="o">|</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">4</span><span class="o">||</span>
  <span class="p">[</span><span class="nx">num</span><span class="p">,</span> <span class="nx">num</span><span class="p">]</span>
</pre></div>
</div>
<p>The program above is equivalent to:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">def</span> <span class="nx">main</span><span class="o">:</span>
  <span class="p">[</span><span class="o">||</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">|</span> <span class="o">+</span> <span class="o">|</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">4</span><span class="o">||</span><span class="p">,</span> <span class="o">||</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">|</span> <span class="o">+</span> <span class="o">|</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">4</span><span class="o">||</span><span class="p">]</span>
</pre></div>
</div>
<p>And, as such, wastefully evaluates <code class="docutils literal notranslate"><span class="pre">||1</span> <span class="pre">+</span> <span class="pre">2|</span> <span class="pre">+</span> <span class="pre">|3</span> <span class="pre">+</span> <span class="pre">4||</span></code> twice. One of the nice things about Formality-Core is that it has a very clear cost model, so we can precisely measure this problem. Save the program above and run it with <code class="docutils literal notranslate"><span class="pre">fmc</span> <span class="pre">-ns</span> <span class="pre">main</span></code>. The <code class="docutils literal notranslate"><span class="pre">-ns</span></code> flags ask <code class="docutils literal notranslate"><span class="pre">fmc</span></code> to run your program with interaction net system (instead of interpreter), and to output the number of “rewrites” needed to fully execute it. Rewrites are lightweight, constant-spacetime operations. In other words, this number is a very good measure of the complexity of the program. A program that takes <code class="docutils literal notranslate"><span class="pre">400</span></code> rewrites is roughly 2x slower than one that takes <code class="docutils literal notranslate"><span class="pre">200</span></code>, and so on. The program above needs <code class="docutils literal notranslate"><span class="pre">12</span></code> rewrites:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ fmc -ns main
<span class="o">[</span><span class="m">10</span>,10<span class="o">]</span>
<span class="o">{</span>
  <span class="s2">&quot;rewrites&quot;</span>: <span class="m">12</span>,
  <span class="s2">&quot;passes&quot;</span>: <span class="m">6</span>
<span class="o">}</span>
</pre></div>
</div>
<p>In order to avoid this waste and copy/clone values efficiently, Formality-Core includes a boxed duplication system, which we’ll explain now. The first thing to learn about is boxes.</p>
</div>
<div class="section" id="boxes">
<h2>8.2. Boxes<a class="headerlink" href="#boxes" title="Permalink to this headline">¶</a></h2>
<p>Boxes are like containers with only one element. You can put any term inside a box using the <code class="docutils literal notranslate"><span class="pre">#</span></code> syntax. For example:</p>
<div class="highlight-swift notranslate"><div class="highlight"><pre><span></span><span class="n">def</span> <span class="n">main</span><span class="p">:</span>
  <span class="p">#</span> <span class="s">&quot;I&#39;m the man in the box&quot;</span>
</pre></div>
</div>
<p>In the program above, the string literal is inside of a box. You can put boxes anywhere you want to. For example:</p>
<div class="highlight-swift notranslate"><div class="highlight"><pre><span></span><span class="n">def</span> <span class="n">main</span><span class="p">:</span>
  <span class="p">#</span> <span class="p">[##</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">#</span><span class="s">&quot;a cat&quot;</span><span class="p">]]</span>
</pre></div>
</div>
<p>The program above puts 4 boxes in different places. If we use the analogy that <em>“a box is like an array with one element”</em>, then it could be written in Python as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Python &quot;equivalent&quot;</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
  <span class="k">print</span> <span class="p">([[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;a cat&quot;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="section" id="duplications">
<h2>8.3. Duplications<a class="headerlink" href="#duplications" title="Permalink to this headline">¶</a></h2>
<p>The reason boxes exist is to enable Formality-Core’s explicit duplications, which are essentially deep copies of arbitrary values. To perform those, you must use the <code class="docutils literal notranslate"><span class="pre">dup</span></code> syntax:</p>
<div class="highlight-swift notranslate"><div class="highlight"><pre><span></span><span class="n">def</span> <span class="n">main</span><span class="p">:</span>
  <span class="n">dup</span> <span class="n">num</span> <span class="p">=</span> <span class="p">#</span><span class="o">||</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">|</span> <span class="o">+</span> <span class="o">|</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">4</span><span class="o">||</span>
  <span class="p">#</span> <span class="p">[</span><span class="n">num</span><span class="p">,</span> <span class="n">num</span><span class="p">]</span>
</pre></div>
</div>
<p>As you can see, this is very similar to the first program presented, with two differences: the <code class="docutils literal notranslate"><span class="pre">dup</span></code> keyword is used instead of <code class="docutils literal notranslate"><span class="pre">let</span></code>, and there is a box (<code class="docutils literal notranslate"><span class="pre">#</span></code>) wrapping the duplicated value and the result. The effect of <code class="docutils literal notranslate"><span class="pre">dup</span></code> is that it takes a boxed value (in this case, <code class="docutils literal notranslate"><span class="pre">#||1</span> <span class="pre">+</span> <span class="pre">2|</span> <span class="pre">+</span> <span class="pre">|3</span> <span class="pre">+</span> <span class="pre">4||</span></code>), unboxes it (obtaining <code class="docutils literal notranslate"><span class="pre">||1</span> <span class="pre">+</span> <span class="pre">2|</span> <span class="pre">+</span> <span class="pre">|3</span> <span class="pre">+</span> <span class="pre">4||</span></code>) and replaces every occurrence of <code class="docutils literal notranslate"><span class="pre">num</span></code> by a copy. The result of this program is, ignoring the box, the same as:</p>
<div class="highlight-swift notranslate"><div class="highlight"><pre><span></span><span class="p">#</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">]</span>
<span class="p">{</span>
  <span class="s">&quot;rewrites&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
  <span class="s">&quot;passes&quot;</span><span class="p">:</span> <span class="mi">5</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Except that now it needed roughly half of the rewrites and, thus, it is twice as fast. This is because duplications are done optimally, so, in this case, the additions were performed before duplicating. This is, of course, a simple example, but in more complex, highly functional programs, clever usage of <code class="docutils literal notranslate"><span class="pre">dup</span></code> can amount to huge, asymptotical speedups.</p>
</div>
<div class="section" id="the-stratification-condition">
<h2>8.4. The stratification condition<a class="headerlink" href="#the-stratification-condition" title="Permalink to this headline">¶</a></h2>
<p>Sadly, in order to use <code class="docutils literal notranslate"><span class="pre">dup</span></code>, there is an important condition that must be met:</p>
<blockquote>
<div>The number of boxes wrapping a term can never change through the program’s evaluation.</div></blockquote>
<p>This is the stratification condition and it essentially causes Formality-Core programs to be split into “layers”, based on how boxes are placed. To explain it, let’s present an example. Mind the code below:</p>
<div class="highlight-swift notranslate"><div class="highlight"><pre><span></span><span class="n">def</span> <span class="n">main</span><span class="p">:</span>
  <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">[#</span><span class="mi">1</span><span class="p">,</span> <span class="p">#[#</span><span class="mi">2</span><span class="p">,</span> <span class="p">##</span><span class="mi">3</span><span class="p">]]]</span>
</pre></div>
</div>
<p>Here, the number <code class="docutils literal notranslate"><span class="pre">0</span></code> isn’t wrapped by any box. As such, it is on <code class="docutils literal notranslate"><span class="pre">layer</span> <span class="pre">0</span></code>. The number <code class="docutils literal notranslate"><span class="pre">1</span></code> is wrapped by one box, so it is on <code class="docutils literal notranslate"><span class="pre">layer</span> <span class="pre">1</span></code>. The entire <code class="docutils literal notranslate"><span class="pre">[#2,</span> <span class="pre">##3]</span></code> pair is wrapped by one box, so, <code class="docutils literal notranslate"><span class="pre">2</span></code> is wrapped by 2 boxes in total and, thus, is on <code class="docutils literal notranslate"><span class="pre">layer</span> <span class="pre">2</span></code>, while <code class="docutils literal notranslate"><span class="pre">3</span></code> is wrapped by 3 boxes in total and, thus, is on <code class="docutils literal notranslate"><span class="pre">layer</span> <span class="pre">3</span></code>.</p>
<p>What the stratification condition says is that a term can never migrate from a layer to another. This means that the program below is not legal:</p>
<div class="highlight-swift notranslate"><div class="highlight"><pre><span></span><span class="n">def</span> <span class="n">main</span><span class="p">:</span>
  <span class="n">dup</span> <span class="n">num</span> <span class="p">=</span> <span class="p">#</span> <span class="mi">42</span>
  <span class="p">[</span><span class="n">num</span><span class="p">,</span> <span class="n">num</span><span class="p">]</span>
</pre></div>
</div>
<p>Because, before reduction, <code class="docutils literal notranslate"><span class="pre">42</span></code> is on <code class="docutils literal notranslate"><span class="pre">layer</span> <span class="pre">1</span></code>, but, after reduction, it would be on <code class="docutils literal notranslate"><span class="pre">layer</span> <span class="pre">0</span></code>. This can’t happen. If you try to run the program above, it will present a compile-time error. Similarly, the program below is illegal too:</p>
<div class="highlight-swift notranslate"><div class="highlight"><pre><span></span><span class="n">def</span> <span class="n">main</span><span class="p">:</span>
  <span class="n">dup</span> <span class="n">num</span> <span class="p">=</span> <span class="p">#</span> <span class="mi">42</span>
  <span class="p">##</span> <span class="p">[</span><span class="n">num</span><span class="p">,</span> <span class="n">num</span><span class="p">]</span>
</pre></div>
</div>
<p>Because, if we evaluated it, <code class="docutils literal notranslate"><span class="pre">42</span></code> would migrate from <code class="docutils literal notranslate"><span class="pre">layer</span> <span class="pre">1</span></code> to <code class="docutils literal notranslate"><span class="pre">layer</span> <span class="pre">2</span></code>, which can’t happen. Trying to run it would result in a compile-time error too. This program is correct:</p>
<div class="highlight-swift notranslate"><div class="highlight"><pre><span></span><span class="n">def</span> <span class="n">main</span><span class="p">:</span>
  <span class="n">dup</span> <span class="n">num</span> <span class="p">=</span> <span class="p">#</span> <span class="mi">42</span>
  <span class="p">#</span> <span class="p">[</span><span class="n">num</span><span class="p">,</span> <span class="n">num</span><span class="p">]</span>
</pre></div>
</div>
<p>Because each occurrence of <code class="docutils literal notranslate"><span class="pre">num</span></code> is on <code class="docutils literal notranslate"><span class="pre">layer</span> <span class="pre">1</span></code>, which is the same layer where <code class="docutils literal notranslate"><span class="pre">42</span></code> is from. This program is also correct:</p>
<div class="highlight-swift notranslate"><div class="highlight"><pre><span></span><span class="n">def</span> <span class="n">main</span><span class="p">:</span>
  <span class="n">dup</span> <span class="n">num</span> <span class="p">=</span> <span class="p">#</span> <span class="mi">42</span>
  <span class="p">[#</span><span class="n">num</span><span class="p">,</span> <span class="p">#</span><span class="n">num</span><span class="p">]</span>
</pre></div>
</div>
<p>Because, once again, each occurrence of <code class="docutils literal notranslate"><span class="pre">num</span></code> is on <code class="docutils literal notranslate"><span class="pre">layer</span> <span class="pre">1</span></code>. This means you’re able to place boxes as you wish, as long as it doesn’t break the stratification condition.</p>
<p>The stratification condition is what allows Formality-Core to be evaluated by the fastest interaction-net reduction algorithm known, dispensing the expensive “bookkeeping mechanism” used by other optimal evaluators.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Lambdas-and-Affinity.html" class="btn btn-neutral float-right" title="9. Lambdas and Affinity" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="If-and-Cpy.html" class="btn btn-neutral float-left" title="7. If and Cpy" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Sunshine Cybernetics

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>